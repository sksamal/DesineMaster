/******************************************************************************

    source file FlowManager.cpp for class: FlowManager

    See header file for details

    Author : T. Kleiberg
    Version: 1
    Date   : June 2004
    Feb8,2016 : Suraj merged changes
******************************************************************************/



// Include(s)
#include "Network/Flow.h"
#include "Network/FlowList.h"
#include "Network/FlowManager.h"
#include "Network/Topology.h"
#include "Parameter/Parameters.h"
#include "RandomVariables/ExponentialVar.h"
#include "RandomVariables/RandomVar.h"
#include "RandomVariables/UniformVar.h"
#include "Utils/TraceManager.h"
#include <iostream>
#include "Utils/Types.h"
#include <cmath>
#include <fstream>
using Types::DblVector;


// Constanst(s)

// Variable(s)

// Function(s) definitions

//------------------------------------------------------------------------------
//  FlowManager::FlowManager(Parameters* parameters, Topology* topology)
//------------------------------------------------------------------------------
FlowManager::FlowManager(Parameters* parameters, Topology* topology)
    : parameters(parameters), topology(topology)
{
    TRACE("FlowManager::FlowManager -->");

    flow_id = 0;
    global_time = 0;

    TRACE("FlowManager::FlowManager <--");
}


//------------------------------------------------------------------------------
//  destructor FlowManager::~FlowManager()
//------------------------------------------------------------------------------
FlowManager::~FlowManager()
{
    TRACE("FlowManager::~FlowManager -->");
    // Empty!
    TRACE("FlowManager::~FlowManager <--");
}


//------------------------------------------------------------------------------
//  Flow* FlowManager::create()
//------------------------------------------------------------------------------
Flow FlowManager::create()
{
    TRACE("FlowManager::create -->");

	int input_type = topology->getInputType();

	if (input_type == 0)
    {
    	int source = topology->getRandomEdgeNode(parameters->endpoints);
    	int dest = source;
    	while (source==dest)
    	{
        	dest = topology->getRandomEdgeNode(parameters->endpoints);
    	}

    	// QoS Constraints
    	int number_of_qos = parameters->qos_cons.size();
   		DblVector qoscons;
    	for (int counter = 0; counter < number_of_qos; ++counter)
    	{
       		qoscons.push_back(parameters->qos_cons[counter]->generate());
   		}
    	double reqc = parameters->f_bandwidth->generate();
    	// set start time of new flow, this is also the new global time
    	global_time  += parameters->f_arrival->generate();
//    	cout<< "initial time is "<<global_time;

    	//added for obs by suraj y.


    	double tend;
    	if(parameters->f_random->generate()>80)
    	{
    		if(parameters->f_random->generate()<parameters->PerBuffTime)
    		    	{
    		    	global_time  += parameters->f_buffer->generate();
    		    	}
    		    	else
    		    	{
    		        	global_time  += parameters->TimeTrigDelay;

    		    	}
//    		    	cout << "initial + buffer is "<<global_time;

    	 tend = global_time + parameters->f_duration1->generate();
    	}
    	else
    	{
        tend   = global_time + parameters->f_duration2->generate();

    	}
    	// for burst add a fixed time and an exponential time to fill buffer
    	Flow result(flow_id++, source, dest, reqc, qoscons, global_time, tend);
    	result.topology = topology;
    	TRACE("FlowManager::create <--");
   		return result;
    } else {
    	int num_pair_sd = topology->getNumSDpairs();
    	int index = ( (int) ceil( num_pair_sd *
                              parameters->endpoints->generate() ) );

		uli source = topology->getflowsrc(index - 1);
		uli dest = topology->getflowdest(index - 1);

		int number_of_qos = parameters->qos_cons.size();
   		DblVector qoscons;
    	for (int counter = 0; counter < number_of_qos; ++counter)
    	{
       		qoscons.push_back(parameters->qos_cons[counter]->generate());
    	}

    	double reqc = topology->getflowreqc(index - 1)/(double)parameters->splitnum; // to give a flow with a smaller scale
    	global_time += parameters->f_arrival->generate();
    	//added for obs by suraj y.

//		cout << "initial is "<<global_time;
		double tend;
    	if(parameters->f_random->generate()>80)
    	{
    		if(parameters->f_random->generate()>parameters->PerBuffTime)
    		    	    	{
    		    	    	global_time  += parameters->f_buffer->generate();
    		    	    	}
    		    	    	else
    		    	    	{
    		    	        	global_time  += parameters->TimeTrigDelay;

    		    	    	}
    		    //	cout << "initial + buffer is "<<global_time;

       	 tend = global_time + parameters->f_duration1->generate();
  	  	}
    	    	else
    	    	{
    	        tend   = global_time + parameters->f_duration2->generate();

    	    	}

    	// for burst add a fixed time and an exponential time to fill buffer

    	Flow result(flow_id ++, source, dest, reqc, qoscons, global_time, tend);
    	result.topology = topology;
    	TRACE("FlowManager::create <--");
   		return result;
    }
}


//------------------------------------------------------------------------------
//  Flow* FlowManager::create()
//------------------------------------------------------------------------------
Flow FlowManager::create(const Flow &original) const
{
    TRACE("FlowManager::create2 -->");
    Flow result(original);
    result.topology = topology;
    TRACE("FlowManager::create2 <--");
    return result;
}

